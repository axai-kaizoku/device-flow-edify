"use client";
import { useEffect, useState } from "react";
import PersonalDetails from "./_components/personal-details";
import OrganisationDetails from "./_components/organisation-details";
import EmailVerificaion from "./_components/email-verification";
import Welcome from "./_components/welcome-note";
import { notFound, useSearchParams } from "next/navigation";
import { validateToken } from "@/server/signupActions";
import DeviceFlowLoader from "@/components/deviceFlowLoader";
import { User } from "@/server/userActions";

function SignUp() {
  const searchParams = useSearchParams();
  const token = searchParams.get("token");

  if (!token) {
    return notFound();
  }

  const [steps, setSteps] = useState(1);
  const [loading, setLoading] = useState(true);
  const [validToken, setValidToken] = useState("");
  const [user, setUser] = useState<User>();

  useEffect(() => {
    const fetch = async () => {
      try {
        const res = await validateToken(token);
        if (res.data?.teamId) {
          setValidToken(token);
        }
        setLoading(false);
      } catch (error) {
        setValidToken("");
        setLoading(false);
      } finally {
        setLoading(false);
      }
    };
    fetch();
  }, [token]);

  if (loading) {
    return (
      <section className="flex flex-col gap-y-6 justify-center items-center h-screen bg-white">
        <DeviceFlowLoader />
        <span className="font-gilroyMedium text-base">
          Validating token ...
        </span>
      </section>
    );
  }

  if (!validToken || validToken.length === 0) {
    return (
      <section className="flex justify-center items-center h-screen bg-white">
        <svg
          width="1440"
          height="833"
          viewBox="0 0 1440 833"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect
            width="1440"
            height="832"
            transform="translate(0 0.5)"
            fill="white"
          />
          <g clipPath="url(#clip0_4046_15155)">
            <path
              opacity="0.2"
              d="M976.376 505.325L962.011 373.617C961.451 368.483 958.904 363.864 954.84 360.614C950.778 357.363 945.699 355.882 940.538 356.438L876.066 363.402C865.832 358.82 855.596 354.238 845.361 349.655C824.123 340.146 802.884 330.637 781.646 321.128C763.394 312.956 745.142 304.785 726.891 296.613C720.832 293.901 714.773 291.188 708.712 288.474C705.858 287.196 703.014 285.69 700.076 284.608C699.947 284.56 699.823 284.495 699.697 284.439C699.424 284.317 699.095 284.353 698.854 284.53C692.415 289.291 685.976 294.052 679.537 298.814C664.076 310.245 648.617 321.677 633.157 333.109C614.463 346.932 595.768 360.754 577.075 374.577C565.923 382.823 554.771 391.069 543.62 399.315L479.147 406.279C468.466 407.433 460.719 417.018 461.879 427.644L476.243 559.352C477.33 569.31 485.856 576.704 495.714 576.645C496.376 576.641 497.044 576.604 497.715 576.532L959.105 526.69C969.788 525.535 977.535 515.951 976.376 505.325ZM571.637 379.539C590.326 364.857 609.015 350.176 627.703 335.494C643.764 322.877 659.823 310.261 675.884 297.644C681.216 293.455 686.547 289.266 691.88 285.077C693.557 283.76 695.232 282.443 696.91 281.126C697.67 280.529 698.788 279.923 699.427 279.16C706.59 282.572 713.756 285.982 720.921 289.392C738.488 297.755 756.056 306.118 773.623 314.483C794.866 324.596 816.108 334.709 837.35 344.821C849.151 350.439 860.952 356.058 872.755 361.676L546.918 398.959C555.159 392.485 563.398 386.012 571.637 379.539ZM512.631 435.871C511.858 438.431 509.609 440.411 506.77 440.718C502.986 441.126 499.584 438.406 499.174 434.639C499.071 433.698 499.165 432.779 499.423 431.926C500.196 429.366 502.444 427.386 505.283 427.079C505.534 427.053 505.775 427.074 506.021 427.074C505.776 427.271 505.52 427.461 505.281 427.664C505.176 427.752 505.057 427.829 504.947 427.91C504.08 428.552 505.076 429.897 505.946 429.253C506.75 428.658 507.554 428.064 508.358 427.469C510.754 428.333 512.586 430.467 512.88 433.157C512.984 434.101 512.889 435.018 512.631 435.871ZM920.983 395.972C917.198 396.381 913.797 393.66 913.386 389.895C913.097 387.241 914.388 384.799 916.49 383.432C917.3 383.788 918.114 384.128 918.936 384.431C919.065 384.479 919.189 384.544 919.316 384.6C920.303 385.042 920.989 383.516 920.002 383.074C919.574 382.883 919.145 382.691 918.717 382.499C918.975 382.441 919.225 382.365 919.495 382.336C923.281 381.927 926.682 384.648 927.092 388.413C927.504 392.179 924.769 395.564 920.983 395.972Z"
              fill="#8C6151"
            />
            <path
              d="M498.042 564.728C488.276 564.728 479.874 557.317 478.857 547.396L465.408 416.182C464.323 405.596 472.053 396.099 482.639 395.014L939.972 348.136C945.087 347.613 950.109 349.119 954.115 352.38C958.121 355.64 960.616 360.253 961.14 365.368L974.589 496.583C975.674 507.169 967.944 516.664 957.358 517.751L500.024 564.627C499.358 564.695 498.697 564.728 498.042 564.728ZM941.464 362.7L484.131 409.58C481.619 409.837 479.715 412.177 479.971 414.69L493.421 545.903C493.677 548.414 496.024 550.314 498.531 550.061L955.864 503.182C958.375 502.925 960.28 500.585 960.022 498.072L946.573 366.859C946.448 365.635 945.843 364.524 944.87 363.732C943.9 362.942 942.698 362.572 941.464 362.7Z"
              fill="white"
            />
            <path
              d="M940.72 355.417L483.387 402.296C476.833 402.968 472.019 408.881 472.692 415.435L486.142 546.648C486.814 553.202 492.727 558.015 499.281 557.343L956.614 510.464C963.168 509.792 967.982 503.879 967.309 497.325L953.859 366.112C953.187 359.558 947.274 354.745 940.72 355.417ZM509.799 429.465C506.047 429.849 502.694 427.119 502.309 423.368C501.925 419.616 504.655 416.263 508.406 415.878C512.158 415.494 515.511 418.224 515.895 421.975C516.28 425.726 513.55 429.08 509.799 429.465ZM920.369 387.379C916.617 387.763 913.264 385.033 912.879 381.283C912.495 377.53 915.225 374.177 918.975 373.793C922.726 373.408 926.081 376.138 926.465 379.889C926.85 383.641 924.121 386.994 920.369 387.379Z"
              fill="#DE2B1D"
            />
            <path
              d="M683.209 516.928C637.164 514.968 628.536 524.343 619.273 545.044L956.615 510.465C963.169 509.793 967.982 503.881 967.31 497.326L959.407 420.228C930.221 428.422 880.841 446.706 841.255 483.632C781.045 539.798 742.927 519.469 683.209 516.928Z"
              fill="#DE2B1D"
            />
            <path
              d="M576.478 431.174C636.055 437.918 665.821 406.594 679.764 382.166L483.387 402.296C476.833 402.968 472.019 408.881 472.692 415.435L476.21 449.761C497.054 437.046 529.508 425.857 576.478 431.174ZM509.799 429.465C506.047 429.849 502.694 427.119 502.309 423.368C501.925 419.616 504.655 416.263 508.406 415.878C512.158 415.494 515.511 418.224 515.895 421.975C516.28 425.727 513.55 429.08 509.799 429.465Z"
              fill="#DE2B1D"
            />
            <path
              d="M919.472 374.531C912.245 371.226 905.017 367.923 897.789 364.618C880.437 356.683 863.084 348.75 845.732 340.815C824.751 331.222 803.768 321.628 782.786 312.035C764.755 303.79 746.725 295.547 728.693 287.302C722.707 284.566 716.72 281.829 710.734 279.091C707.915 277.801 705.106 276.285 702.203 275.191C702.075 275.143 701.953 275.076 701.829 275.021C701.559 274.897 701.233 274.93 700.993 275.106C694.587 279.808 688.18 284.51 681.772 289.212C666.391 300.501 651.009 311.791 635.627 323.08C617.028 336.73 598.427 350.382 579.828 364.032C563.845 375.763 547.861 387.493 531.878 399.224C526.571 403.119 521.265 407.013 515.958 410.908C513.457 412.744 510.775 414.463 508.396 416.459C508.293 416.547 508.174 416.621 508.065 416.702C507.202 417.336 508.181 418.682 509.047 418.045C515.454 413.343 521.86 408.641 528.268 403.939C543.65 392.65 559.032 381.36 574.414 370.071C593.013 356.419 611.613 342.769 630.212 329.118C646.196 317.387 662.179 305.656 678.163 293.926C683.469 290.031 688.775 286.136 694.082 282.242C695.75 281.017 697.419 279.792 699.088 278.568C699.846 278.013 700.956 277.451 701.593 276.74C708.671 279.976 715.747 283.212 722.824 286.448C740.176 294.381 757.529 302.315 774.881 310.25C795.862 319.843 816.845 329.437 837.827 339.03C855.858 347.275 873.888 355.518 891.92 363.763C897.906 366.5 903.893 369.238 909.879 371.974C912.698 373.264 915.507 374.78 918.41 375.874C918.538 375.922 918.66 375.989 918.784 376.045C919.76 376.492 920.447 374.977 919.472 374.531Z"
              fill="#8C6151"
            />
            <path
              opacity="0.3"
              d="M712.848 282.194C713.471 288.267 709.052 293.695 702.978 294.318C696.905 294.941 691.476 290.522 690.853 284.449C690.231 278.375 694.65 272.947 700.723 272.324C706.797 271.701 712.225 276.12 712.848 282.194Z"
              fill="#8C6151"
            />
            <path
              d="M712.848 278.201C713.471 284.274 709.052 289.702 702.978 290.325C696.905 290.948 691.476 286.529 690.853 280.455C690.231 274.382 694.65 268.954 700.723 268.331C706.797 267.708 712.225 272.127 712.848 278.201Z"
              fill="#4D4D4D"
            />
            <rect
              x="529.558"
              y="444.643"
              width="380.857"
              height="78.3108"
              transform="rotate(-5.89814 529.558 444.643)"
              stroke="white"
              strokeWidth="7.58701"
            />
            <path
              d="M556.822 499.772L568.615 498.554L569.388 506.032L548.605 508.179L543.197 455.829L552.186 454.9L556.822 499.772Z"
              fill="white"
            />
            <path
              d="M581.117 451.912L586.525 504.262L577.536 505.191L572.128 452.84L581.117 451.912Z"
              fill="white"
            />
            <path
              d="M608.854 449.046L617.843 448.118L623.251 500.468L614.262 501.397L602.319 472.321L602.175 472.336L605.273 502.325L596.284 503.254L590.876 450.904L600.368 449.923L611.708 478.078L611.851 478.063L608.854 449.046Z"
              fill="white"
            />
            <path
              d="M651.851 497.513L640.568 478.347L640.136 478.391L639.974 478.937L641.999 498.531L633.01 499.46L627.601 447.109L636.591 446.181L638.522 464.877L638.666 464.863L645.58 445.252L654.065 444.376L644.33 469.039L662.206 496.444L651.851 497.513Z"
              fill="white"
            />
            <path
              d="M702.616 446.918L689.887 448.233L691.216 461.097L700.349 460.153L701.121 467.632L691.989 468.575L693.75 485.626L707.485 484.207L708.258 491.686L685.534 494.034L680.126 441.683L701.843 439.44L702.616 446.918Z"
              fill="white"
            />
            <path
              d="M740.724 435.423L732.425 462.735L746.132 487.773L737.503 488.665L728.383 472.147L723.408 490.121L714.706 491.02L723.077 463.701L709.298 438.67L718 437.771L727.055 454.371L732.094 436.315L740.724 435.423Z"
              fill="white"
            />
            <path
              d="M777.097 446.782C778.217 457.626 772.604 463.799 765.844 464.498C765.269 464.557 761.594 464.861 761.019 464.921L763.197 486.01L754.28 486.932L748.872 434.581L762.895 433.133C771.452 432.249 776.231 438.406 777.097 446.782ZM760.2 456.993L761.997 456.808C767.822 456.206 769.399 455.287 768.611 447.659C768.178 443.471 766.903 440.277 763.308 440.648L758.562 441.139L760.2 456.993Z"
              fill="white"
            />
            <path
              d="M792.691 430.055L798.099 482.405L789.11 483.333L783.702 430.983L792.691 430.055Z"
              fill="white"
            />
            <path
              d="M837.557 478.328L828.209 479.294L817.472 459.089C816.25 459.215 814.956 459.349 814.596 459.386L816.775 480.475L807.858 481.397L802.449 429.046L817.479 427.494C826.109 426.602 830.887 432.76 831.753 441.136C832.556 448.914 829.838 454.259 825.755 456.948L837.557 478.328ZM812.139 435.604L813.777 451.458L816.653 451.161C822.478 450.56 823.983 449.648 823.195 442.02C822.763 437.832 821.488 434.638 817.964 435.002L812.139 435.604Z"
              fill="white"
            />
            <path
              d="M861.806 430.473L849.077 431.788L850.406 444.651L859.539 443.708L860.312 451.186L851.179 452.13L852.94 469.181L866.676 467.762L867.448 475.241L844.724 477.588L839.316 425.238L861.033 422.994L861.806 430.473Z"
              fill="white"
            />
            <path
              d="M897.79 427.965C898.43 429.939 898.934 432.004 899.158 434.173L901.476 456.608C902.303 464.61 899.569 471.922 891.803 472.725L875.551 474.404L870.142 422.053L886.395 420.374C891.5 419.847 896.122 423.073 897.79 427.965ZM883.767 465.996L889.16 465.439C892.756 465.068 893.351 461.68 892.918 457.492L890.601 435.057C890.168 430.869 888.893 427.675 885.298 428.046L879.904 428.603L883.767 465.996Z"
              fill="white"
            />
          </g>
          <defs>
            <clipPath id="clip0_4046_15155">
              <rect
                width="665.535"
                height="665.535"
                fill="white"
                transform="translate(387.232 83.7324)"
              />
            </clipPath>
          </defs>
        </svg>
      </section>
    );
  }

  return (
    <>
      {steps === 1 && (
        <EmailVerificaion user={user} setUser={setUser} setSteps={setSteps} />
      )}
      {steps === 2 && (
        <PersonalDetails setSteps={setSteps} user={user} setUser={setUser} />
      )}
      {steps === 3 && (
        <OrganisationDetails
          setSteps={setSteps}
          token={validToken}
          user={user}
        />
      )}
      {steps === 4 && <Welcome />}
    </>
  );
}

export default SignUp;
